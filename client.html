<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>APL</title>
  <style>
    body {
      font-family: sans-serif;
      background: #0b0c10;
      color: #eaf0f6;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    input,
    button {
      padding: 8px 12px;
      margin: 5px;
      border-radius: 6px;
      border: none;
      margin-bottom: 50px;
      margin-top: 30px;
    }

    #videos {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    video {
      width: 640px;
      height: 360px;
      background: #000;
      border-radius: 8px;
    }

    #controls {
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    #controls button {
      background:none;
      border:none;
      cursor:pointer;
      padding:5px;
      border-radius:6px;
      transition:background 0.2s;
    }
    #controls button:hover { background:rgba(255,255,255,0.1);}
    #controls svg { width:32px; height:32px; }
  </style>
</head>

<body>
  <h2>APL</h2>
  <div>
    <span>id: <b id="myId">â€”</b></span>
  </div>
  <div>
    <input id="peerId" placeholder="Call id" />
    <button id="callBtn">Connect</button>
    <button id="hangBtn">Disconnect</button>
  </div>
  <div id="videos">
    <video id="local" autoplay muted playsinline></video>
    <video id="remote" autoplay playsinline></video>
  </div>
  <div id="controls">
    <button id="camBtn" title="Camera">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="#eaf0f6" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M17 10.5V6c0-1.1-0.9-2-2-2H5C3.9 4 3 4.9 3 6v12c0 1.1 0.9 2 2 2h10c1.1 0 2-0.9 2-2v-4.5l4 4v-11l-4 4z" />
      </svg>
    </button>
    <button id="micBtn" title="Mic">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="#eaf0f6" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3s-3 1.34-3 3v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-0.49 6-3.39 6-6.92h-2z" />
      </svg>
    </button>
  </div>
  <pre id="log"></pre>
  <script>
    const logEl = document.getElementById('log'); const log = (m) => { logEl.textContent += m + "\n"; }
    const myId = Math.random().toString(36).slice(2, 8); document.getElementById('myId').textContent = myId;
    const peerInput = document.getElementById('peerId'); const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn'); const localVideo = document.getElementById('local');
    const remoteVideo = document.getElementById('remote');
    const SIGNAL = 'wss://YOUR_SIGNAL_SERVER:8080';
    let ws = new WebSocket(SIGNAL); let pc; let localStream; let remoteId = '';

    ws.onopen = () => log('WS connected');
    ws.onmessage = async (e) => {
      const msg = JSON.parse(e.data);
      if (msg.type === 'offer') {
        await ensurePC();
        await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: 'answer', to: msg.from, payload: pc.localDescription }));
        log('Answer sent');
      } else if (msg.type === 'answer') {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
        log('Answer received');
      } else if (msg.type === 'candidate') {
        try { await pc.addIceCandidate(msg.payload); } catch (e) { }
      }
    };

    ws.onclose = () => log('WS closed');

    ws.onopen = () => { ws.send(JSON.stringify({ type: 'register', id: myId })); }

    async function ensurePC() {
      if (pc) return;
      pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      pc.onicecandidate = e => { if (e.candidate && remoteId) ws.send(JSON.stringify({ type: 'candidate', to: remoteId, payload: e.candidate })); };
      pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
      pc.onconnectionstatechange = () => log('PC state: ' + pc.connectionState);
      localStream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, frameRate: 60 }, audio: true });
      localVideo.srcObject = localStream;
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    }

    callBtn.onclick = async () => {
      remoteId = peerInput.value.trim();
      if (!remoteId) { alert('Enter call id'); return; }
      await ensurePC();
      const offer = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true });
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({ type: 'offer', to: remoteId, payload: pc.localDescription }));
      log('Offer sent to ' + remoteId);
    };

    hangBtn.onclick = () => {
      if (pc) { pc.getSenders().forEach(s => s.track && s.track.stop()); pc.close(); pc = null; }
      localVideo.srcObject = null; remoteVideo.srcObject = null;
      if (remoteId) ws.send(JSON.stringify({ type: 'bye', to: remoteId }));
      log('Call ended');
    };

    let camEnabled = true;
    let micEnabled = true;

    const camBtn = document.getElementById('camBtn');
    const micBtn = document.getElementById('micBtn');

    camBtn.onclick = () => {
      camEnabled = !camEnabled;
      localStream.getVideoTracks().forEach(track => track.enabled = camEnabled);
      camBtn.querySelector('path').setAttribute('fill', camEnabled ? '#eaf0f6' : '#ff4d4d');
    };

    micBtn.onclick = () => {
      micEnabled = !micEnabled;
      localStream.getAudioTracks().forEach(track => track.enabled = micEnabled);
      micBtn.querySelector('path').setAttribute('fill', micEnabled ? '#eaf0f6' : '#ff4d4d');
    };

  </script>
</body>

</html>