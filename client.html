<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>APL</title>
<style>
body { font-family: sans-serif; background:#0b0c10; color:#eaf0f6; display:flex; flex-direction:column; align-items:center; padding:20px; }
input, button { padding:8px 12px; margin:5px; border-radius:6px; border:none; margin-bottom:30px; margin-top:10px; }
#videos { display:flex; gap:10px; margin-top:10px; }
video { width:720px; height:405px; background:#000; border-radius:8px; }
#controls { display:flex; gap:10px; margin-top:10px; }
#controls button { background:none; border:none; cursor:pointer; padding:5px; border-radius:6px; color:#fff; font-weight:bold; transition:background 0.2s; }
#controls button:hover { background: rgba(255,255,255,0.1); }
</style>
</head>
<body>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<h2>APL</h2>
<div>id: <b id="myId">â€”</b></div>
<div>
  <input id="peerId" placeholder="Call id" />
  <button id="callBtn">Connect</button>
  <button id="hangBtn">Disconnect</button>
</div>

<div id="videos">
  <video id="local" autoplay muted playsinline></video>
  <video id="remote" autoplay playsinline></video>
</div>

<div id="controls">
  <button id="camBtn">Cam: OFF</button>
  <button id="micBtn">Mic: OFF</button>
</div>
<pre id="log"></pre>

<script>
const logEl = document.getElementById('log');
const log = m => { logEl.textContent += m + "\n"; }

const myId = Math.random().toString(36).slice(2,8);
document.getElementById('myId').textContent = myId;

const peerInput = document.getElementById('peerId');
const callBtn = document.getElementById('callBtn');
const hangBtn = document.getElementById('hangBtn');
const localVideo = document.getElementById('local');
const remoteVideo = document.getElementById('remote');

let pc, localStream=null, remoteId='', camOn=false, micOn=false;

const socket = io('http://87.249.49.93:8443');
socket.on('connect', () => { log('Socket.IO connected'); socket.emit('register', {id: myId}); });
socket.on('disconnect', () => log('Socket.IO disconnected'));

socket.on('signal', async msg => {
  if(msg.type==='offer'){
    remoteId = msg.from;
    log(`Call from ${remoteId}`);
    await ensurePC();
    await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('signal',{type:'answer', to:remoteId, payload: pc.localDescription, from: myId});
  } else if(msg.type==='answer'){
    await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
  } else if(msg.type==='candidate'){
    try { await pc.addIceCandidate(msg.payload); } catch(e){}
  } else if(msg.type==='bye'){
    hangUp(false);
    log('Call ended by remote');
  }
});

async function ensurePC(){
  if(pc) return;
  pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.onicecandidate = e => { if(e.candidate && remoteId) socket.emit('signal',{type:'candidate', to:remoteId, payload:e.candidate, from:myId}); };
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  if(localStream){
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }
}

async function startLocal(){
  if(localStream) return;
  localStream = await navigator.mediaDevices.getUserMedia({
    video:{width:1280,height:720,frameRate:30},
    audio:true
  });
  localVideo.srcObject = localStream;

  localStream.getVideoTracks().forEach(t=>t.enabled = false);
  localStream.getAudioTracks().forEach(t=>t.enabled = false);
}

callBtn.onclick = async ()=>{
  remoteId = peerInput.value.trim();
  if(!remoteId){ alert('Enter call id'); return; }
  log(`Call to ${remoteId}`);
  await startLocal();
  await ensurePC();
  const offer = await pc.createOffer({offerToReceiveAudio:true, offerToReceiveVideo:true});
  await pc.setLocalDescription(offer);
  socket.emit('signal',{type:'offer', to:remoteId, payload:offer, from:myId});
};

function hangUp(sendBye=true){
  if(pc){ pc.getSenders().forEach(s=>s.track && s.track.stop()); pc.close(); pc=null; }
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  localStream=null;
  localVideo.srcObject=null; remoteVideo.srcObject=null;
  if(sendBye && remoteId) socket.emit('signal',{type:'bye', to:remoteId, from:myId});
}
hangBtn.onclick = ()=>hangUp(true);

document.getElementById('camBtn').onclick = async ()=>{
  if(!localStream) await startLocal();
  camOn = !camOn;
  localStream.getVideoTracks().forEach(t=>t.enabled=camOn);
  document.getElementById('camBtn').textContent = `Cam: ${camOn?'ON':'OFF'}`;
};
document.getElementById('micBtn').onclick = async ()=>{
  if(!localStream) await startLocal();
  micOn = !micOn;
  localStream.getAudioTracks().forEach(t=>t.enabled=micOn);
  document.getElementById('micBtn').textContent = `Mic: ${micOn?'ON':'OFF'}`;
};
</script>
</body>
</html>
